{% extends "base.html" %}

{% block content %}
<h2>{{ course.title }}</h2>
<p>{{ course.description }}</p>

<hr>

<!--Live course chat with chat history-->
<h3>Course Chat</h3>
<div id="chat-log" style="border:1px solid #ccc; height:300px; overflow-y:scroll; padding:5px;">
    {% for msg in messages %}
        <b>{{ msg.sender.username }}:</b> {{ msg.message}} <br>
    {% endfor %}
</div>
<input id="chat-message-input" type="text" size="80">
<button id="chat-message-submit">Send</button>

<script>
    const courseId = "{{ course.id }}";
    const chatLog = document.querySelector('#chat-log');
    const chatInput = document.querySelector('#chat-message-input');
    const chatSubmit = document.querySelector('#chat-message-submit');

    const chatSocket = new WebSocket(
        (window.location.protocol === "https:" ? "wss://" : "ws://") +
        window.location.host +
        "/ws/chat/" + courseId + "/"
    ); //Connect to correct websocket url

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        chatLog.innerHTML += '<b>' + data.sender + ':</b> ' + data.message + '<br>';
        chatLog.scrollTop = chatLog.scrollHeight;
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    chatSubmit.onclick = function() {
        const message = chatInput.value;
        if(message.trim() === "") return;
        chatSocket.send(JSON.stringify({'message': message}));
        chatInput.value = '';
    };

    chatInput.addEventListener("keyup", function(event) {
        if(event.key === "Enter") {
            chatSubmit.click();
        }
    });
</script>
{% endblock %}